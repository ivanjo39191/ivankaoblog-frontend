import Vue from 'vue'
import VueRouter from 'vue-router'
import Cookies from 'js-cookie'
import NProgress from 'nprogress'

Vue.use(VueRouter)

const routes = [
  {
    path: '/index',
    name: 'Home',
    component: () => import('../views/Home.vue')
  },
  {
    path: '/index/count',
    name: 'count',
    component: () => import('../components/count.vue')
  },
  {
    path: '/index/login',
    name: 'Login',
    component: () => import('../views/login/index.vue'),
  },
  // 其他路由
  {
    path: '/index/home',
    name: 'home',
    component: () => import('../views/Home.vue'),
    meta: { requireAuth: true }, // 用來作為此頁是否需要權限驗證的設定
    // children: [...]
  },
  {
    path: '/index/userinfo',
    name: 'userinfo',
    component: () => import('../components/UserInfo.vue'),
    meta: { requireAuth: true },
  }
]

// eslint-disable-next-line no-new
const router = new VueRouter({
  mode: 'history',
  base: process.env.BASE_URL,
  routes
})

router.beforeEach(async(to, from, next) => {
  // 看看 to 和 from 兩個 arguments 會吐回什麼訊息
  console.log('to: ', to)
  console.log('from: ', from)
  NProgress.start()
  // 目的路由在meta上是否有設置requireAuth: true
  if (to.meta.requireAuth) {
    // 獲取Cookies當中的login資訊並取得token
    const info = Cookies.get('login')
    if (info) {
      const token = JSON.parse(info).token
      console.log(token)
      // 如果token不為空，且確實有這個欄位則讓路由變更
      if (token.length > 0 || token === undefined) {
        next()
      } else {
        // 未通過則導回login頁面
        next({ name: 'Login' })
      }
    } else {
      next({ name: 'Login' })
    }
  } else {
    next()
  }
})

router.afterEach(() => {
  // finish progress bar
  NProgress.done()
})

export default router
